---
title: "Main"
editor_options: 
   chunk_output_type: console
---

```{r setup}
#| echo: false
#| message: false
#| warning: false
source("_common.R")
```

## Catalog

```{r}
catalog_json <- \() {
  
  m <- arrow::read_json_arrow(
    file = "https://data.cms.gov/data.json", 
    col_select = c("@context", "@id", "@type", "conformsTo", "describedBy"),
    as_data_frame = FALSE) |> 
  dplyr::collect() |> 
  dplyr::rename_with(remove_at_symbol)
  
  list(
    context = m$context,
    id = m$id,
    type = m$type,
    conformsTo = m$conformsTo,
    describedBy = m$describedBy
    )
}

catalog_json() |> 
  purse()
```

## Dataset

```{r}
#| label: data_json
data_json <- read_json_arrow(
  file = "https://data.cms.gov/data.json",
  col_select = c("dataset"),
    as_data_frame = TRUE) |> 
  to_duckdb() |> 
  pull(dataset) |> 
  pluck(1) |> 
  tibble()

dataset_json <- data_json |> 
  unnest_wider(contactPoint, names_sep = "_") |>
  unnest_wider(publisher, names_sep = "_") |> 
  mutate(
    distribution = NULL,
    bureauCode = delist(bureauCode),
    keyword = map_chr(keyword, \(x) paste0(delist(x), collapse = ", ")),
    language = delist(language),
    programCode = delist(programCode),
    theme = map_chr(theme, \(x) paste0(delist(x), collapse = ", ")),
    references = delist(references)) |>
  rename_with(remove_at_symbol)

dataset_json |> 
  purse()
```


## Distribution

```{r}
distribution_json <- data_json |> 
  select(distribution) |> 
  unnest(distribution)

distribution_json |> 
  purse()
```
