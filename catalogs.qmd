---
title: "Data Catalogs"
editor_options: 
   chunk_output_type: console
---

```{r setup}
#| echo: false
#| message: false
#| warning: false
knitr::opts_chunk$set(
  dev        = "ragg_png",
  dpi        = 320,
  out.width  = "100%",
  fig.width  = 8,
  fig.asp    = 0.818,
  fig.retina = 2,
  fig.align  = "center",
  fig.show   = "hold"
)
options(scipen = 999, digits = 3)

library(tidyverse)
library(provider)
library(fuimus)
library(httr2)
library(arrow)
library(terse)
library(emphatic)

purse <- function(x, 
                  pre = "- ", 
                  wid = 100, 
                  sep = " ") {
  terse::terse(
    x = x, 
    prefix = pre, 
    width = wid, 
    config = list(
      gsep = sep, 
      ansi = FALSE))
}
```


# Data Catalogs

## Main CMS

```{r}
#| eval: false
# https://data.cms.gov/data-api/v1/dataset/
catalogs <- c(
  main = read_json_arrow(
    file = "https://data.cms.gov/data.json", 
    col_select = c("dataset"),
    as_data_frame = TRUE) |> 
    to_duckdb(),
  provider = request("https://data.cms.gov/provider-data/api/1/metastore/schemas/dataset/items"),
  open = request("https://openpaymentsdata.cms.gov/api/1/metastore/schemas/dataset/items?show-reference-ids"),
  eligibility = request("https://qpp.cms.gov/api/eligibility")
)

catalogs
```

> **Note:** Removing `col_select = c("dataset")` from the above call returns the following metadata:

```{r}
#| label: col_select_remove
#| echo: false
c("@context    <chr> https://project-open-data.cio.gov/v1.1/schema/catalog.jsonld", 
  "@id         <chr> https://data.cms.gov/data.json", 
  "@type       <chr> dcat:Catalog", 
  "conformsTo  <chr> https://project-open-data.cio.gov/v1.1/schema", 
  "describedBy <chr> https://project-open-data.cio.gov/v1.1/schema/catalog.json", 
  "dataset     <list> [<data.frame[138 x 22]>]") |> 
  cat(sep = "\n")
```

## Provider CMS

```{r}
request('https://data.cms.gov/provider-data/api/1/metastore/schemas/dataset/items') |>
  req_perform() |>
  resp_body_json(simplifyVector = TRUE) |> 
  tibble() |> 
  purse()
```


## QPP CMS

   * [QPP Eligibility API Documentation](https://cmsgov.github.io/qpp-eligibility-docs/)
   * [QPP Eligibility REST API Documentation](https://qpp.cms.gov/api/eligibility/docs/)

> Note: Not really a catalog

```{r}
request("https://qpp.cms.gov/api/eligibility/stats/?year=2025") |>
  req_headers(Accept = "application/vnd.qpp.cms.gov.v6+json") |>
  req_perform() |>
  resp_body_json(simplifyVector = TRUE)

request("https://qpp.cms.gov/api/eligibility/npis/1043477615/?year=2025") |>
  req_headers(Accept = "application/vnd.qpp.cms.gov.v6+json") |>
  req_error(body = \(resp) resp_body_json(resp)$error$message) |>
  req_perform() |>
  resp_body_json(simplifyVector = TRUE) |> 
  pluck(1) |> 
  tibble() |> 
  glimpse()
```


### GraphQL API

   * [Basic Clinician GraphQL Example](https://cmsgov.github.io/qpp-eligibility-docs/clinician)
   * [QPP Eligibility GraphQL API Documentation](https://qpp.cms.gov/api/eligibility/graphql)
