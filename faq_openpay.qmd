---
title: "Open Payments API"
editor_options: 
   chunk_output_type: console
---
```{r}
#| label: setup-common-01
#| include: false
source("includes/_common.R")
```

## Dataset

   * `publisher`: `"openpaymentsdata.cms.gov"`
   * `bureauCode`: `"009:38"`
   * `programCode`: `"009:000"`
   * `accessLevel`: `"public"`

```{r}
#| label: open_dataset
open_dataset <- qTBL(
  fload("https://openpaymentsdata.cms.gov/api/1/metastore/schemas/dataset/items?show-reference-ids"), 
  keep.attr = TRUE) |>
    mtt(issued             = as_date(issued),
        modified           = as_date(modified),
        accrualPeriodicity = recode_iso8601(accrualPeriodicity),
        description        = sf_remove(description, "\n"),
        bureauCode         = delist(bureauCode),
        programCode        = delist(programCode),
        theme              = delist(map(theme, \(x) gelm(as.list(x), "data"))),
        year               = delist(map(keyword, \(x) gelm(as.list(x), "data"))),
        # `%modified`        = as_date(`%modified`, fmt = "%Y-%m-%dT%H:%M:%Ez")
        `%modified`        = clock::date_time_parse_RFC_3339(`%modified`, offset = "%Ez")
        ) |> 
  slt(year,
      title,
      description,
      theme,
      issued,
      modified,
      modified_dttm = `%modified`,
      temporal,
      accrualPeriodicity,
      distribution)

open_dataset
```


```{r}
# identifiers <- uniq(qTBL(rowbind(gelm(open_dataset, "keyword"))))
```


```{r}
identifier <- qTBL(rowbind(gelm(open_dataset, "distribution"), fill = TRUE), keep.attr = TRUE)

identifier
```


```{r}
distribution <- qTBL(rowbind(gelm(identifier, "data"), fill = TRUE), keep.attr = TRUE) |> 
  slt(-`@type`)

distribution |> 
  select(`%Ref:downloadURL`) |> 
  unnest_wider(`%Ref:downloadURL`, names_sep = "_") |> 
  head()
```

```{r}
# qTBL(distribution[["%Ref:downloadURL"]])
# qTBL(rowbind(, fill = TRUE), keep.attr = TRUE)
```

```{r}
#| label: open_data
open_data <- request(
  "https://openpaymentsdata.cms.gov/api/1/metastore/schemas/dataset/items?show-reference-ids"
  ) |>
  req_perform() |>
  resp_body_json(simplifyVector = TRUE) |> 
  tibble()

open_data |> 
  unnest_wider(keyword, names_sep = "_") |>
  unnest_wider(theme, names_sep = "_") |>
  unnest_wider(contactPoint, names_sep = "_") |>
  unnest_wider(publisher, names_sep = "_") |> 
  unnest_wider(publisher_data, names_sep = "_") |> 
  unnest_wider(distribution, names_sep = "_") |> 
  unnest_wider(distribution_data, names_sep = "_") |> 
  unnest_wider(`distribution_data_%Ref:downloadURL`, names_sep = "_") |> 
  unnest_wider(`distribution_data_%Ref:downloadURL_1`, names_sep = "_") |> 
  unnest_wider(`distribution_data_%Ref:downloadURL_1_data`, names_sep = "_") |> 
  mutate(
    description        = replace_open_desc(description),
    bureauCode         = delist(bureauCode),
    programCode        = delist(programCode)) |>
  rename_with(remove_at_symbol) |> 
  rename(modified_dttm = `%modified`) |> 
  remove_all_na()

open_data |> 
  purse()
```
