---
title: "Open Payments API"
editor_options: 
   chunk_output_type: console
---
```{r}
#| label: setup-common-01
#| include: false
source("includes/_common.R")
```

## Dataset

   * `publisher`: `"openpaymentsdata.cms.gov"`
   * `bureauCode`: `"009:38"`
   * `programCode`: `"009:000"`
   * `accessLevel`: `"public"`
   * limit = `500`

```{r}
#| label: open_dataset
dataset <- fastplyr::as_tbl(
  mtt(
    fload("https://openpaymentsdata.cms.gov/api/1/metastore/schemas/dataset/items?show-reference-ids"), 
    modified = as_date(modified), 
    description = sf_replace(description, "\n", ". "), 
    description = sf_remove(description, "\r. \r."), 
    theme = delist(map(theme, function(x) get_elem(as.list(x), "data"))), 
    year = delist(map(keyword, function(x) get_elem(as.list(x), "data"))), 
    year = sf_replace(year, "all years", "All", fix = TRUE), 
    identifier = paste0("https://openpaymentsdata.cms.gov/api/1/datastore/query/", identifier, "/0")))

describedby <- map(get_elem(get_elem(dataset$distribution, "data", DF.as.list = TRUE), "title|describedBy", regex = TRUE), function(x) x[not_null(names(x))])

dataset <- roworder(slt(join(add_vars(dataset, downloadURL = delist(get_elem(get_elem(dataset$distribution, "data", DF.as.list = TRUE), "downloadURL"))), 
      cheapr::new_df(title = delist(get_elem(describedby, "title")), describedBy = delist(get_elem(describedby, "describedBy"))) |> 
  mtt(year = stringi::stri_extract_all_regex(title, "[0-9]{4}"),
      name = stringi::stri_extract_all_regex(title, "^.*(?=\\s.\\sDetailed Dataset [0-9]{4} Reporting Year)"),
      title = ifelse(na(name), title, glue::glue("{year} {name}")),
      year = NULL,
      name = NULL),
      on = "title", 
      verbose = 0), 
    year, 
    theme, 
    title, 
    description, 
    modified, 
    temporal, 
    identifier, 
    downloadURL, 
    describedBy), 
  -theme, 
  -year, 
  title)

dataset <- collapse::rsplit(dataset, ~ theme)

dataset <- list(
  SummaryAll = sbt(dataset$Summary, year == "All", -year),
  SummaryYear = mtt(sbt(dataset$Summary, year != "All", -describedBy), 
                    year = as_int(year)),
  General = mtt(dataset$`General Payments`, year = as_int(year)),
  Research = mtt(dataset$`Research Payments`, year = as_int(year)),
  Ownership = mtt(dataset$`Ownership Payments`, year = as_int(year)))

dataset
```

## Dictionaries

### Covered Recipient Profile Supplement

```{r}
#| label: dict_covered_recipient_profile
dict_covered_recipient <- dataset$SummaryAll |> 
  sbt(not_na(describedBy)) |> 
  _[["describedBy"]] |> 
  request() |> 
  req_perform() |> 
  resp_body_json() |> 
  fastplyr::as_tbl() |> 
  _[["data"]]

dict_covered_recipient$title

fastplyr::new_tbl(
  field = delist(get_elem(dict_covered_recipient$fields, "name")),
  description = delist(get_elem(dict_covered_recipient$fields, "description")))
```

### General Payment File

```{r}
#| label: dict_general_payments
dict_general <- dataset$General |> 
  sbt(year == "2023") |> 
  _[["describedBy"]] |> 
  request() |> 
  req_perform() |> 
  resp_body_json() |> 
  fastplyr::as_tbl() |> 
  _[["data"]]

dict_general$title

fastplyr::new_tbl(
  field = delist(get_elem(dict_general$fields, "name")),
  description = delist(get_elem(dict_general$fields, "description")))
```

### Ownership Payment File

```{r}
#| label: dict_ownership
dict_owner <- dataset$Ownership |> 
  sbt(year == "2023") |> 
  _[["describedBy"]] |> 
  request() |> 
  req_perform() |> 
  resp_body_json() |> 
  fastplyr::as_tbl() |> 
  _[["data"]]

dict_owner$title

fastplyr::new_tbl(
  field = delist(get_elem(dict_owner$fields, "name")),
  description = delist(get_elem(dict_owner$fields, "description")))
```

### Ownership Payment File

```{r}
#| label: dict_research
dict_research <- dataset$Research |> 
  sbt(year == "2023") |> 
  _[["describedBy"]] |> 
  request() |> 
  req_perform() |> 
  resp_body_json() |> 
  fastplyr::as_tbl() |> 
  _[["data"]]

dict_research$title

fastplyr::new_tbl(
  field = delist(get_elem(dict_research$fields, "name")),
  description = delist(get_elem(dict_research$fields, "description")))
```

## New Function

```{r}
fields <- c(
  "year",
  "covered_recipient_npi",                                         
  "covered_recipient_type",                                        
  "covered_recipient_first_name",                                  
  "covered_recipient_last_name",                                   
  "recipient_city",                                                
  "recipient_state",                                               
  "recipient_zip_code",                                            
  "teaching_hospital_name",                                        
  "form_of_payment_or_transfer_of_value",                          
  "nature_of_payment_or_transfer_of_value",                        
  "applicable_manufacturer_or_applicable_gpo_making_payment_name",
  "applicable_manufacturer_or_applicable_gpo_making_payment_id")

process_params <- \(arg_names, field_names) {
  
  nms <- set_names(arg_names, field_names)
  
  parse_expr(
    paste0(
      "list2(", 
      glue_collapse(
        glue('{names(nms)} = {unname(nms)}'), 
        sep = ", "), ")"))
}

has_operator <- \(args) {
  map_lgl(args, function(x) inherits(x, "query_operator"))
}

name_path <- \(args) {
  map(args, \(x) x[[names(x)]][["path"]] <- names(x))
}
```


```{r}
open_pay <- function(year,
                     npi               = NULL,
                     covered_type      = NULL,
                     first             = NULL,
                     last              = NULL,
                     city              = NULL,
                     state             = NULL,
                     zip               = NULL,
                     teaching_hospital = NULL,
                     payment_form      = NULL,
                     payment_nature    = NULL,
                     payer             = NULL,
                     payer_id          = NULL) {
  
  fn_args <- process_params(fn_fmls_names(), fields) |> 
    eval_bare() |> 
    compact()
  
  # if (any(has_operator(fn_args))) fn_args[has_operator(fn_args)] <- name_path(fn_args[has_operator(fn_args)])
  
  fn_args
}
```

```{r}
open_pay(year = 2021, npi = "1043218118")
open_pay(year = 2021, payment_nature = "Royalty or License")
open_pay(year = 2021, payment_form = "Stock option")
open_pay(year = 2021, payer = "Adaptive Biotechnologies Corporation")
open_pay(year = 2021, teaching_hospital = "Nyu Langone Hospitals")
open_pay(year = 2017:2023, npi = "1043477615")
```

```{r}
starts_with <- \(x) {
  structure(
    c(path      = NA_character_,
      operator  = "STARTS_WITH",
      value     = x),
    class = "query_operator")
}

starts_with("Royalty or License")

x <- open_pay(
  year = 2021, 
  payment_nature = starts_with("Royalty or License"), 
  teaching_hospital = starts_with("NYU"))

x

names(x[has_operator(x)])

x[has_operator(x)][[1]][["path"]] <- names(x[has_operator(x)])[[1]]

x

# map(args, \(x) x[[names(x)]][["path"]] <- names(x))
# 
# x[has_operator(x)] <- providertwo:::map2(
#   x[has_operator(x)], 
#   names(x[has_operator(x)]), 
#   function(x, y) x[["path"]] <- y)
# 
# x
```


## Query Format

```{r}
url_parse(
  base_url = "https://openpaymentsdata.cms.gov/api/1/datastore/", 
  url      = "query/fdc3c773-018a-412c-8a81-d7b8a13a037b/0") |> 
  url_modify_query(
    `conditions[0][property]` = "covered_recipient_first_name",
    `conditions[0][value]`    = "PATRICK",
    `conditions[0][operator]` = "=",
    `conditions[1][property]` = "covered_recipient_last_name",
    `conditions[1][value]`    = "WARD",
    `conditions[1][operator]` = "=",
    schema                    = "false",
    keys                      = "false",
    results                   = "false",
    offset                    = 0) |>
  url_build() |> 
  request() |> 
  req_perform() |> 
  resp_body_json(simplifyVector = TRUE)
```

