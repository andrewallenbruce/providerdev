# API FAQ

Working through the new (October 2024 - Version 1.6) [API FAQ](https://data.cms.gov/sites/default/files/2024-10/7ef65521-65a4-41ed-b600-3a0011f8ec4b/API%20Guide%20Formatted%201_6.pdf) for [data.CMS.gov](https://data.cms.gov/api-docs), extracting the relevant information

```{r setup}
#| echo: false
#| message: false
#| warning: false
knitr::opts_chunk$set(
  dev        = "ragg_png",
  dpi        = 320,
  out.width  = "100%",
  fig.width  = 8,
  fig.asp    = 0.818,
  fig.retina = 2,
  fig.align  = "center",
  fig.show   = "hold"
)
options(scipen = 999, digits = 3)

library(tidyverse)
library(fastverse)
library(provider)
library(fuimus)
library(httr2)
library(arrow)
```

## Data Catalog

The [`data.json`](https://data.cms.gov/data.json) file is an [**Open Data**](https://resources.data.gov/resources/dcat-us/) catalog containing the datasets available on our site. As new data is added, it is automatically updated to the **data.json**.


```{r}
#| label: catalog1
data_json_meta <- read_json_arrow(
  file = "https://data.cms.gov/data.json",
  col_select = c("dataset"),
    as_data_frame = TRUE) |> 
  to_duckdb()

data_json_meta |> 
  glimpse()
```


In the **data.json**, there is an array called **dataset**. You can search through this array using the title of your dataset, such as `"Payroll Based Journal Daily Nurse Staffing"`:


```{r}
#| label: catalog2
data_json_meta |> 
  pull(dataset) |> 
  pluck(1) |> 
  filter(grepl("Payroll Based Journal Daily Nurse Staffing", title)) |> 
  glimpse()
```


Inside of the dataset, there is an array called **distribution** which will contain all the versions of the data in all available formats for each version. 

```{r}
#| label: catalog3
data_json_meta |> 
  pull(dataset) |> 
  pluck(1) |> 
  slice(1) |> 
  select(distribution) |> 
  unnest(distribution) |> 
  glimpse()
```




In this array there are a few different types of entries:

The first entry (with a description of 'latest') will provide a URL that will always point to the latest data, even as new versions are published.

The remaining entries will provide references to the data at fixed points in time, listed in descending order by date. 

For example, the URL in the following example will *always* point to the **Payroll Based Journal Daily Nurse Staffing** data from **Q2 2021**:


```{r}
#| label: url_nurse
resp_nurse <- request("https://data.cms.gov/data-api/v1/dataset/d10d792e-ea6e-4145-8512-34efbc1be04b/data") |> 
  req_perform(verbosity = 3) |> 
  resp_body_json(simplifyVector = TRUE)

glimpse(head(resp_nurse, 1))
```


Some datasets will have multiple historical versions available and some will only have the most recent data available.

The data with mediaType of "text/csv" is downloadable as a CSV file and data with mediaType of "application/zip" is downloadable as a ZIP file.

The data with a format of "API" will point to an API endpoint.

> How can I get an earlier version of the data?

If your data has earlier versions available, there is a "temporal" field in the distribution section of the data.json file which will indicate the time period. An example is below.



```{r}
#| label: url_hospital
data_json_url <- "https://data.cms.gov/data.json"
dataset_title <- "Medicare Inpatient Hospitals - by Provider and Service"
time_period   <- "2017-01-01/2017-12-31"

data_json_meta <- read_json_arrow(
  file = data_json_url,
  col_select = c("dataset"),
    as_data_frame = TRUE)

meta <- to_duckdb(data_json_meta) |> 
  pull(dataset) |> 
  pluck(1)
  
meta |> 
  dplyr::filter(grepl(dataset_title, title)) |> 
  dplyr::glimpse()
```
